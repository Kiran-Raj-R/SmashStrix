<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Management - SmashStrix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Custom styles for sidebar and hover effects */
    .sidebar {
      transition: width 0.3s ease;
    }
    .sidebar.collapsed {
      width: 0;
      padding: 0;
    }
    .main-content {
      transition: margin-left 0.3s ease;
    }
    .main-content.expanded {
      margin-left: 0;
    }
    @media (max-width: 640px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.collapsed {
        transform: translateX(0);
      }
      .main-content {
        margin-left: 0;
        padding: 0 1rem; /* Ensure padding on mobile */
      }
    }
    @media (min-width: 1024px) {
      .layout {
        display: flex;
        min-height: 100vh; /* Ensure full height */
        gap: 1rem; /* Adds small gap between sidebar and content */
      }
      .sidebar {
        position: static; /* remove fixed for desktop */
        width: 64px; 
        flex-shrink: 0;
      }
      .sidebar:not(.collapsed) {
        width: 256px;
      }
      .main-content {
        flex-grow: 1;
        margin-left: 0; /* remove margin pushing */
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans">
  <!-- Layout Container -->
  <div class="layout">
    <!-- Sidebar -->
    <nav class="sidebar bg-white shadow-lg z-50 md:flex md:flex-col" id="sidebar">
      <div class="p-4 flex-shrink-0">
        <h2 class="text-xl font-bold text-gray-800">Smashkart</h2>
      </div>
      <ul class="space-y-2 p-4 flex-grow overflow-y-auto">
        <li><a href="{% url 'admin:index' %}" class="flex items-center p-2 rounded hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-tachometer-alt mr-3"></i> Dashboard</a></li>
        <li><a href="#" class="flex items-center p-2 rounded hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-box mr-3"></i> Products</a></li>
        <li><a href="#" class="flex items-center p-2 rounded hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-list mr-3"></i> Order List</a></li>
        <li><a href="{% url 'admin:user_list' %}" class="flex items-center p-2 rounded hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-users mr-3"></i> Customers</a></li>
        <li><a href="#" class="flex items-center p-2 rounded hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-chart-line mr-3"></i> Sales</a></li>
        <li><a href="{% url 'admin:category_list' %}" class="flex items-center p-2 rounded hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-tags mr-3"></i> Categories</a></li>
        <li><a href="#" class="flex items-center p-2 rounded hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-ticket mr-3"></i> Coupons</a></li>
        <li><a href="#" class="flex items-center p-2 rounded hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-image mr-3"></i> Banners</a></li>
        <li><a href="#" class="flex items-center p-2 rounded hover:bg-gray-100 text-gray-700"><i class="fa-solid fa-user-gear mr-3"></i> Account</a></li>
        <li><a href="{% url 'admin:logout' %}" class="flex items-center p-2 rounded hover:bg-red-100 text-red-600"><i class="fa-solid fa-sign-out-alt mr-3"></i> Logout</a></li>
      </ul>
    </nav>

    <!-- Overlay for Sidebar (Mobile) -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden md:hidden"></div>

    <!-- Main Content -->
    <div class="main-content expanded p-4" id="mainContent">
      <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
      <!-- Header -->
      <div class="flex flex-col md:flex-row justify-between items-center mb-6">
        <button id="toggleSidebar" class="md:hidden text-gray-600 mb-4">
          <i class="fa-solid fa-bars text-2xl"></i>
        </button>
        <h1 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">User Management</h1>
      </div>

      <div class="mb-4 flex space-x-4">
        <input type="text" id="searchUser" class="border rounded p-2 w-1/3" placeholder="Search by username or email...">
        <button id="searchButton" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Search</button>
        <button id="clearSearch" class="bg-gray-300 text-black px-4 py-2 rounded hover:bg-gray-400">Clear</button>
      </div>
      <table class="w-full bg-white shadow-md rounded-lg overflow-hidden">
        <thead class="bg-blue-800 text-white">
          <tr>
            <th class="p-3 text-left">Username</th>
            <th class="p-3 text-left">Email</th>
            <th class="p-3 text-left">Status</th>
            <th class="p-3 text-left">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in page_obj %}
            <tr class="border-b">
              <td class="p-3">{{ user.username }}</td>
              <td class="p-3">{{ user.email }}</td>
              <td class="p-3">{{ user.is_active|yesno:"Active,Blocked" }}</td>
              <td class="p-3">
                <button class="block-user bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700"
                        data-user-id="{{ user.id }}"
                        data-action="{% if user.is_active %}block{% else %}unblock{% endif %}">
                  {{ user.is_active|yesno:"Block,Unblock" }}
                </button>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="4" class="p-3 text-center">No users found.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="mt-4 flex justify-between">
        <span>Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }}</span>
        <div class="space-x-2">
          {% if page_obj.has_previous %}
            <a href="?page=1" class="text-blue-600 hover:underline">First</a>
            <a href="?page={{ page_obj.previous_page_number }}" class="text-blue-600 hover:underline">Previous</a>
          {% endif %}
          {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="text-blue-600 hover:underline">Next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}" class="text-blue-600 hover:underline">Last</a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js" crossorigin="anonymous"></script>
  <script>
  // Sidebar Toggle
  const toggleSidebar = document.getElementById('toggleSidebar');
  const sidebar = document.querySelector('.sidebar');
  const mainContent = document.querySelector('.main-content');
  const sidebarOverlay = document.getElementById('sidebar-overlay');

  toggleSidebar.addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    mainContent.classList.toggle('expanded');
    sidebarOverlay.classList.toggle('hidden');
  });

  sidebarOverlay.addEventListener('click', () => {
    sidebar.classList.add('collapsed');
    mainContent.classList.add('expanded');
    sidebarOverlay.classList.add('hidden');
  });

  // User Management Scripts
  function updateUserStatus(button, isActive) {
    button.textContent = isActive ? 'Block' : 'Unblock';
    button.dataset.action = isActive ? 'block' : 'unblock';
    const row = button.closest('tr');
    if (row) {
      const statusCell = row.querySelector('td:nth-child(3)');
      if (statusCell) {
        statusCell.textContent = isActive ? 'Active' : 'Blocked';
        console.log(`Updated user ${button.dataset.userId} to ${isActive ? 'Active' : 'Blocked'}`);
      } 
      else {
        console.error('Status cell not found');
      }
    } else {
      console.error('Row not found');
    }
  }
  

  document.querySelectorAll('.block-user').forEach(button => {
    button.addEventListener('click', () => {
      const userId = button.dataset.userId;
      const currentAction = button.dataset.action;
      console.log(`Attempting to ${currentAction} user ${userId}`);
      if (confirm(`Are you sure you want to ${currentAction} user ${userId}?`)) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfToken) {
          console.error('CSRF token not found');
          alert('CSRF token missing. Please refresh the page.');
          return;
        }
        fetch(`/admin/toggle-user-status/${userId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken.value
          }
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Response data:', data);
          if (data.status === 'success') {
            updateUserStatus(button, data.is_active);
          } else {
            alert(`Failed to update user status: ${data.message || 'Unknown error'}`);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while updating user status. Check console for details.');
        });
      }
    });
  });

  // Search Functionality
  document.getElementById('searchButton').addEventListener('click', () => {
    const searchTerm = document.getElementById('searchUser').value.trim();
    if (searchTerm) {
      window.location.href = `${window.location.pathname}?search=${encodeURIComponent(searchTerm)}`;
    } else {
      alert('Please enter a search term');
    }
  });

  document.getElementById('clearSearch').addEventListener('click', () => {
    document.getElementById('searchUser').value = '';
    window.location.href = window.location.pathname;
  });
</script>