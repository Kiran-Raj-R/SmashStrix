{% extends 'admin_base.html' %}

{% block title %}Brand Management - SmashStrix{% endblock %}

{% block extra_css %}
  <style>
    /* Page-specific styles */
    @media (max-width: 640px) {
      .main-content {
        padding: 0 1rem; /* Ensure padding on mobile */
      }
    }
    .brand-icon {
      width: 50px;
      height: 50px;
      object-fit: contain;
    }
  </style>
{% endblock %}

{% block content %}
  <!-- CSRF Token Form -->
  <form style="display: none;"><input type="hidden" name="csrfmiddlewaretoken" value="{% csrf_token %}"></form>

  <!-- Header -->
  <div class="flex flex-col md:flex-row justify-between items-center mb-6">
    <button id="toggleSidebar" class="md:hidden text-gray-600 mb-4">
      <i class="fa-solid fa-bars text-2xl"></i>
    </button>
    <h1 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">Brand Management</h1>
  </div>

  <div class="mb-6 flex justify-between items-center">
    <div class="flex space-x-4">
      <input type="text" id="searchBrand" class="border rounded-lg p-2 w-64" placeholder="Search by brand name...">
      <button id="clearSearch" class="bg-gray-300 text-black px-4 py-2 rounded-lg hover:bg-gray-400">Clear</button>
    </div>
    <a href="{% url 'admin:add_brand' %}" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add Brand</a>
  </div>
  <div class="bg-white shadow-lg rounded-lg overflow-hidden">
    <table class="w-full">
      <thead class="bg-blue-800 text-white">
        <tr>
          <th class="p-4 text-left">Name</th>
          <th class="p-4 text-left">Icon</th>
          <th class="p-4 text-left">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for brand in page_obj %}
          <tr class="border-b hover:bg-gray-100">
            <td class="p-4">{{ brand.name }}</td>
            <td class="p-4">
              {% if brand.icon %}
                <img src="{{ brand.icon.url }}" alt="{{ brand.name }} icon" class="brand-icon">
              {% else %}
                No Icon
              {% endif %}
            </td>
            <td class="p-4 flex space-x-2">
              <button class="toggle-brand bg-gray-600 text-white px-2 py-1 rounded hover:bg-gray-700"
                      data-brand-id="{{ brand.id }}"
                      data-action="{% if brand.is_active %}unlist{% else %}list{% endif %}"
                      data-toggle-url="{% url 'admin:toggle_brand_status' brand.id %}">
                {{ brand.is_active|yesno:"Unlist,List" }}
              </button>
              <a href="{% url 'admin:edit_brand' brand.id %}" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700">Edit</a>
              <button class="delete-brand bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700"
                      data-brand-id="{{ brand.id }}"
                      data-delete-url="{% url 'admin:delete_brand' brand.id %}">Delete</button>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="3" class="p-4 text-center">No brands found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="mt-6 flex justify-between items-center">
    <span>Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }}</span>
    <div class="space-x-2">
      {% if page_obj.has_previous %}
        <a href="?page=1" class="text-blue-600 hover:underline">First</a>
        <a href="?page={{ page_obj.previous_page_number }}" class="text-blue-600 hover:underline">Previous</a>
      {% endif %}
      {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}" class="text-blue-600 hover:underline">Next</a>
        <a href="?page={{ page_obj.paginator.num_pages }}" class="text-blue-600 hover:underline">Last</a>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // Search and Clear Functionality
    document.getElementById('clearSearch').addEventListener('click', () => {
      document.getElementById('searchBrand').value = '';
      window.location.href = window.location.pathname;
    });

    document.getElementById('searchBrand').addEventListener('input', (e) => {
      window.location.href = `${window.location.pathname}?search=${e.target.value}`;
    });

    // Toggle List/Unlist Functionality
    document.querySelectorAll('.toggle-brand').forEach(button => {
      button.addEventListener('click', () => {
        const brandId = button.dataset.brandId;
        const action = button.dataset.action;
        const url = button.dataset.toggleUrl;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        console.log(`Sending toggle request to: ${url}, CSRF: ${csrfToken}`); // Debug
        if (!csrfToken) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'CSRF token is missing. Please refresh the page.'
          });
          return;
        }
        Swal.fire({
          title: `Are you sure you want to ${action} this brand?`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes',
          cancelButtonText: 'No'
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
              }
            })
            .then(response => {
              console.log('Toggle Response Status:', response.status, 'URL:', url); // Debug
              return response.json();
            })
            .then(data => {
              console.log('Toggle Data:', data); // Debug
              if (data.status === 'success') {
                button.textContent = data.is_active ? 'Unlist' : 'List';
                button.dataset.action = data.is_active ? 'unlist' : 'list';
                Swal.fire({
                  icon: 'success',
                  title: `Brand ${data.is_active ? 'listed' : 'unlisted'} successfully`,
                  timer: 1500,
                  showConfirmButton: false
                });
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: data.message || 'Failed to update brand status'
                });
              }
            })
            .catch(error => {
              console.error('Toggle Error:', error, 'URL:', url); // Debug
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while updating the brand status'
              });
            });
          }
        });
      });
    });

    // Delete Brand Functionality
    document.querySelectorAll('.delete-brand').forEach(button => {
      button.addEventListener('click', () => {
        const brandId = button.dataset.brandId;
        const url = button.dataset.deleteUrl;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        console.log(`Sending delete request to: ${url}, CSRF: ${csrfToken}`); // Debug
        if (!csrfToken) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'CSRF token is missing. Please refresh the page.'
          });
          return;
        }
        Swal.fire({
          title: 'Are you sure you want to delete this brand?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, delete it',
          cancelButtonText: 'No'
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
              }
            })
            .then(response => {
              console.log('Delete Response Status:', response.status, 'URL:', url); // Debug
              return response.json();
            })
            .then(data => {
              console.log('Delete Data:', data); // Debug
              if (data.status === 'success') {
                Swal.fire({
                  icon: 'success',
                  title: 'Brand deleted successfully',
                  timer: 1500,
                  showConfirmButton: false
                }).then(() => {
                  window.location.reload(); // Reload to update table
                });
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: data.message || 'Failed to delete brand'
                });
              }
            })
            .catch(error => {
              console.error('Delete Error:', error, 'URL:', url); // Debug
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred while deleting the brand'
              });
            });
          }
        });
      });
    });
  </script>
{% endblock %}